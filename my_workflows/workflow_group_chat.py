import os

import autogen
from agents.for_other.code_executor_agent import DockerCodeExecutor
from tools.for_group_chat.pentest_tools import nmap_scanner

config_list = autogen.config_list_from_json(
    "../OAI_CONFIG_LIST",
    file_location=os.getcwd(),
    filter_dict={
        "model": ["gpt-4", "gpt-4-0314", "gpt4", "gpt-4-32k", "gpt-4-32k-0314", "gpt-4-32k-v0314"],
    },
)

llm_config_scanner = {"config_list": config_list, "cache_seed": 42}
llm_config_manager = {"config_list": config_list, "cache_seed": 42}
llm_config_reporter = {"config_list": config_list, "cache_seed": 42}

executor = DockerCodeExecutor().get_executor()

user_proxy = autogen.UserProxyAgent(
    name="User_proxy",
    system_message="A human admin.",
    code_execution_config={
        "executor": executor
    },  # Please set use_docker=True if docker is available to run the generated code. Using docker is safer than
    # running the generated code directly.
    human_input_mode="TERMINATE",
)
scaner_agent = autogen.AssistantAgent(
    name="scaner_agent",
    llm_config=llm_config_scanner,
    system_message="You are Scan network agent!"
                   "Goals: "
                   "1) Scan received ip address by nmap tool!"
                   "2) Send result to reporting_agent!"
)
reporting_agent = autogen.AssistantAgent(
    name="reporting_agent",
    system_message="You are Reporting agent "
                   "Goals: Create a security report after you have received a result from scaner_agent.",
    llm_config=llm_config_reporter,
)


# Register the tool signature with the scaner agent.
scaner_agent.register_for_llm(name="")(nmap_scanner)

# Register the tool function with the user proxy agent.
user_proxy.register_for_execution()(nmap_scanner)

group_chat = autogen.GroupChat(agents=[user_proxy, scaner_agent, reporting_agent], messages=[], max_round=12)
manager = autogen.GroupChatManager(groupchat=group_chat, llm_config=llm_config_manager)

user_proxy.initiate_chat(
    manager, message="scan  63.251.228.0-63.251.228.100, "
                     "ports: 80, 443, 21, 22, 25, 110, 143, 993, 995, 3306, 3389, 5900, 8080"
)
# type exit to terminate the chat
